<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - AURA DIGITAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #050b14; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tab-btn.active { background: linear-gradient(90deg, rgba(59,130,246,0.15) 0%, transparent 100%); border-left: 4px solid #3b82f6; color: #60a5fa; padding-left: 1.5rem; }
        .badge-admin { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
        .badge-vip { background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid #eab308; box-shadow: 0 0 10px rgba(234, 179, 8, 0.4); }
        .badge-basic { background: rgba(100, 116, 139, 0.15); color: #94a3b8; border: 1px solid #64748b; }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="loginSection" class="h-screen flex justify-center items-center">
        <div class="glass-panel p-12 rounded-[40px] text-center w-full max-w-md">
            <h2 class="text-4xl font-black mb-8 text-white">Admin Core</h2>
            <input type="password" id="adminPass" class="w-full px-6 py-5 bg-slate-900/80 border border-slate-700 rounded-2xl mb-6 text-white text-center text-xl outline-none" placeholder="••••••••">
            <button onclick="login()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase">Authenticate</button>
        </div>
    </div>

    <div id="dashSection" class="hidden flex h-screen">
        <div class="w-80 glass-panel border-r border-slate-800/80 flex flex-col p-8 space-y-2">
            <h2 class="text-3xl font-black mb-12 text-white">AURA <span class="text-blue-500">DIGITAL</span></h2>
            <button onclick="showTab('stats', this)" class="tab-btn active text-left p-4 hover:bg-slate-800/40 rounded-xl font-bold text-slate-400 uppercase text-sm mb-1"><i class="fa-solid fa-chart-pie mr-4"></i> Overview</button>
            <button onclick="showTab('products', this)" class="tab-btn text-left p-4 hover:bg-slate-800/40 rounded-xl font-bold text-slate-400 uppercase text-sm mb-1"><i class="fa-solid fa-box-open mr-4"></i> Products</button>
            <button onclick="showTab('deposits', this)" class="tab-btn text-left p-4 hover:bg-slate-800/40 rounded-xl font-bold text-slate-400 uppercase text-sm mb-1"><i class="fa-solid fa-money-bill-transfer mr-4"></i> Deposits</button>
            <button onclick="showTab('users', this)" class="tab-btn text-left p-4 hover:bg-slate-800/40 rounded-xl font-bold text-slate-400 uppercase text-sm mb-1"><i class="fa-solid fa-users mr-4"></i> Users</button>
        </div>

        <div class="flex-1 p-10 overflow-y-auto">
            <div id="statsTab" class="tab-content"><h1 class="text-4xl font-black mb-10 text-white">Dashboard</h1><div class="grid grid-cols-2 gap-8"><div class="glass-panel p-8 rounded-[32px] border-l-4 border-l-blue-500"><p class="text-slate-400 font-black mb-1 uppercase text-xs">Total Users</p><h2 class="text-5xl font-black text-white" id="statUsers">0</h2></div><div class="glass-panel p-8 rounded-[32px] border-l-4 border-l-emerald-500"><p class="text-slate-400 font-black mb-1 uppercase text-xs">Total Revenue</p><h2 class="text-5xl font-black text-emerald-400" id="statRev">$0</h2></div></div></div>
            
            <div id="productsTab" class="tab-content hidden"><h1 class="text-4xl font-black mb-10 text-white">Products</h1><div class="glass-panel rounded-[32px] overflow-hidden"><table class="w-full text-left"><thead class="bg-slate-800/40"><tr class="text-slate-400 text-xs uppercase"><th class="p-6">Title</th><th class="p-6">Price</th><th class="p-6 text-right">Action</th></tr></thead><tbody id="adminProductList" class="divide-y divide-slate-700/30"></tbody></table></div></div>
            
            <div id="depositsTab" class="tab-content hidden"><h1 class="text-4xl font-black mb-10 text-white">Deposits</h1><div class="glass-panel rounded-[32px] overflow-hidden"><table class="w-full text-left"><thead class="bg-slate-800/40"><tr class="text-slate-400 text-xs uppercase"><th class="p-6">User</th><th class="p-6">TrxID/Method</th><th class="p-6">Amount</th><th class="p-6 text-right">Action</th></tr></thead><tbody id="depositListBody" class="divide-y divide-slate-700/30"></tbody></table></div></div>
            
            <div id="usersTab" class="tab-content hidden">
                <div class="flex justify-between items-end mb-8"><h1 class="text-4xl font-black text-white">Users</h1><input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Search..." class="bg-slate-900/80 border border-slate-700 px-6 py-3 rounded-xl text-white outline-none"></div>
                <div class="glass-panel rounded-[32px] overflow-hidden">
                    <table class="w-full text-left"><thead class="bg-slate-800/40"><tr class="text-slate-400 text-xs uppercase"><th class="p-6">Name</th><th class="p-6">Email</th><th class="p-6">Balance</th><th class="p-6 text-right">Actions</th></tr></thead><tbody id="userListBody" class="divide-y divide-slate-700/30"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pass = sessionStorage.getItem('adminPass'); let globalUsers = [];
        if(pass) checkAuth();

        async function login() { pass = document.getElementById('adminPass').value; const res = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass}) }); if(res.ok) { sessionStorage.setItem('adminPass', pass); checkAuth(); } else alert('Denied'); }
        async function checkAuth() { document.getElementById('loginSection').classList.add('hidden'); document.getElementById('dashSection').classList.remove('hidden'); loadAllData(); }
        function showTab(tabId, btn) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(tabId + 'Tab').classList.remove('hidden'); btn.classList.add('active'); }
        
        function getBadge(role, isVip) {
            if(role === 'ADMIN') return '<span class="px-2 py-0.5 rounded text-[10px] font-black badge-admin ml-2">ADMIN</span>';
            if(isVip) return '<span class="px-2 py-0.5 rounded text-[10px] font-black badge-vip ml-2">VIP</span>';
            return '<span class="px-2 py-0.5 rounded text-[10px] font-black badge-basic ml-2">BASIC</span>';
        }

        async function loadAllData() {
            const res = await fetch('/api/admin/stats'); const data = await res.json();
            document.getElementById('statUsers').innerText = data.users; document.getElementById('statRev').innerText = "$" + data.revenue.toFixed(2);
            globalUsers = data.userList; renderUsers(globalUsers);
            document.getElementById('depositListBody').innerHTML = data.deposits.map(d => `<tr class="hover:bg-slate-800/20"><td class="p-6 font-bold">${d.user.firstName}</td><td class="p-6 text-sm text-slate-400 font-mono">${d.trxId}<br><span class="text-blue-400 font-black text-xs uppercase">${d.method}</span></td><td class="p-6 font-black text-emerald-400">৳${d.amountBdt}</td><td class="p-6 text-right">${d.status === 'PENDING' ? `<button onclick="actionDeposit(${d.id}, 'APPROVE')" class="bg-emerald-500/20 text-emerald-400 px-4 py-2 rounded-lg font-bold text-xs mr-2">Approve</button><button onclick="actionDeposit(${d.id}, 'REJECT')" class="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg font-bold text-xs">Reject</button>` : `<span class="text-[10px]">${d.status}</span>`}</td></tr>`).join('');
            document.getElementById('adminProductList').innerHTML = data.products.map(p => `<tr class="hover:bg-slate-800/20"><td class="p-6 font-bold">${p.name}</td><td class="p-6 text-blue-400 font-black">$${p.price.replace(/[^0-9.]/g, '')}</td><td class="p-6 text-right"><button onclick="deleteProduct(${p.id})" class="text-red-400 p-2 bg-red-500/10 rounded-lg"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('');
        }

        function filterUsers() { const q = document.getElementById('userSearch').value.toLowerCase(); renderUsers(globalUsers.filter(u => u.firstName.toLowerCase().includes(q))); }
        function renderUsers(users) { 
            document.getElementById('userListBody').innerHTML = users.map(u => `
            <tr class="hover:bg-slate-800/20 ${u.isBanned ? 'opacity-50' : ''}">
                <td class="p-6 font-bold text-white flex items-center">${u.avatar ? `<img src="${u.avatar}" class="w-8 h-8 rounded-full object-cover mr-3 border border-slate-600">` : `<div class="w-8 h-8 rounded-full bg-slate-700 mr-3 flex items-center justify-center">${u.firstName.charAt(0)}</div>`} ${u.firstName} ${getBadge(u.role, u.isVip)} <br> ${u.isBanned?'<span class="text-red-500 ml-2">BANNED</span>':''}</td>
                <td class="p-6 text-sm text-slate-400">${u.email}</td><td class="p-6 text-emerald-400 font-black">$${u.balanceUsd.toFixed(2)}</td>
                <td class="p-6 text-right">
                    <button onclick="editBalance(${u.id}, ${u.balanceUsd})" class="bg-blue-500/20 text-blue-400 p-2 rounded-lg mr-2" title="Edit Balance"><i class="fa-solid fa-wallet"></i></button>
                    <button onclick="toggleAdmin(${u.id}, '${u.role}')" class="bg-purple-500/20 text-purple-400 p-2 rounded-lg mr-2" title="Toggle Admin Role"><i class="fa-solid fa-user-shield"></i></button>
                    <button onclick="toggleBan(${u.id}, ${u.isBanned})" class="${u.isBanned?'bg-red-500 text-white':'bg-red-500/10 text-red-400'} p-2 rounded-lg"><i class="fa-solid fa-ban"></i></button>
                </td>
            </tr>`).join(''); 
        }

        async function editBalance(id, currentBalance) { const { value: amount } = await Swal.fire({ title: 'Set Balance', input: 'number', inputValue: currentBalance, showCancelButton: true }); if (amount) { await fetch('/api/admin/user/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password:pass, action:'balance', id, amount})}); loadAllData(); } }
        async function toggleAdmin(id, currentRole) { const newRole = currentRole === 'ADMIN' ? 'USER' : 'ADMIN'; if(confirm(`Change role to ${newRole}?`)) { await fetch('/api/admin/user/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password:pass, action:'role', id, role: newRole})}); loadAllData(); } }
        async function toggleBan(id, isBanned) { if(confirm(isBanned ? 'Unban user?' : 'BAN this user?')) { await fetch('/api/admin/user/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password:pass, action:'ban', id})}); loadAllData(); } }
        async function actionDeposit(id, action) { await fetch('/api/admin/deposit/action', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass, id, action}) }); loadAllData(); }
        async function deleteProduct(id) { if(confirm('Delete?')) { await fetch('/api/admin/product/'+id, { method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass}) }); loadAllData(); } }
    </script>
</body>
</html>
