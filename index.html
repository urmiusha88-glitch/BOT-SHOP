<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Bot Store - Ononto Hasan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .theme-bkash { border-color: #e2136e; outline-color: #e2136e; }
        .theme-nagad { border-color: #f37021; outline-color: #f37021; }
        .theme-rocket { border-color: #8c1596; outline-color: #8c1596; }
        .btn-bkash { background-color: #e2136e; color: white; }
        .btn-nagad { background-color: #f37021; color: white; }
        .btn-rocket { background-color: #8c1596; color: white; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 antialiased selection:bg-blue-200">

    <nav class="glass-effect fixed w-full z-50 top-0 border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex-shrink-0 flex items-center gap-2">
                    <i class="fa-solid fa-robot text-blue-600 text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight">Bot<span class="text-blue-600">Store</span></span>
                </div>
                
                <div id="authSection" class="flex items-center space-x-4">
                    </div>
            </div>
        </div>
    </nav>

    <div class="pt-28 pb-12 sm:pt-32 sm:pb-16 bg-gradient-to-b from-blue-50 to-slate-50 text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-4 text-slate-900">Next-Gen <span class="text-blue-600">Source Codes</span></h1>
        <p class="mt-4 max-w-2xl mx-auto text-xl text-slate-500">Enhance your workflow with premium, ready-to-use Telegram bots.</p>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full flex justify-center py-12 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-4xl"></i></div>
        </div>
    </div>

    <div id="addFundModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden justify-center items-center z-[100] px-4">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all">
            <div id="modalHeader" class="bg-slate-800 p-4 flex justify-between items-center text-white transition-colors duration-300">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-wallet mr-2"></i> Add Fund</h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-300"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <form id="depositForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Payment Method</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="bkash" class="peer sr-only" checked onchange="updateTheme()">
                            <div class="p-2 border-2 rounded-xl text-center peer-checked:theme-bkash peer-checked:bg-pink-50 transition-all font-bold text-pink-600">bKash</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="nagad" class="peer sr-only" onchange="updateTheme()">
                            <div class="p-2 border-2 rounded-xl text-center peer-checked:theme-nagad peer-checked:bg-orange-50 transition-all font-bold text-orange-500">Nagad</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="rocket" class="peer sr-only" onchange="updateTheme()">
                            <div class="p-2 border-2 rounded-xl text-center peer-checked:theme-rocket peer-checked:bg-purple-50 transition-all font-bold text-purple-600">Rocket</div>
                        </label>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-bold text-slate-700">Amount (USD $)</label>
                        <input type="number" step="0.01" id="usdAmount" oninput="calcBdt()" required class="mt-1 block w-full px-4 py-2 border rounded-xl focus:ring-0 bg-slate-50" placeholder="0.00">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-bold text-slate-700">Payable (BDT ৳)</label>
                        <input type="text" id="bdtAmount" disabled class="mt-1 block w-full px-4 py-2 border rounded-xl bg-slate-100 font-bold text-slate-700" value="0.00">
                    </div>
                </div>

                <div id="instructionBox" class="bg-pink-50 border border-pink-200 p-4 rounded-xl text-sm">
                    <p class="font-bold text-pink-700 mb-1">Step-by-step Instruction:</p>
                    <ol class="list-decimal list-inside text-pink-800 space-y-1">
                        <li>Go to your bKash App.</li>
                        <li>Select <b>Send Money</b>.</li>
                        <li>Enter Number: <b class="text-lg">01846849460</b></li>
                        <li>Send exact <b id="insAmount">0</b> BDT.</li>
                        <li>Copy the TrxID and paste below.</li>
                    </ol>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700">Sender Number</label>
                    <input type="text" id="senderNumber" required class="mt-1 block w-full px-4 py-2 border rounded-xl bg-slate-50" placeholder="e.g. 018XXXXXXXX">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700">Transaction ID (TrxID)</label>
                    <input type="text" id="trxId" required class="mt-1 block w-full px-4 py-2 border rounded-xl bg-slate-50 uppercase" placeholder="e.g. 9F8G7H6J">
                </div>

                <button type="submit" id="submitBtn" class="w-full btn-bkash font-bold py-3 rounded-xl shadow-md transition-all">
                    Submit Request
                </button>
            </form>
        </div>
    </div>

    <script>
        let liveRate = 120;
        let currentUser = JSON.parse(localStorage.getItem('user'));
        
        // 1. Initialize
        async function init() {
            checkAuth();
            loadProducts();
            
            // Get live rate
            try {
                const res = await fetch('/api/rate');
                const data = await res.json();
                liveRate = data.rate;
            } catch(e) {}
            
            // Update balance if logged in
            if(currentUser) {
                try {
                    const res = await fetch('/api/user/' + currentUser.id);
                    const data = await res.json();
                    if(data.success) {
                        currentUser.balanceUsd = data.balanceUsd;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        checkAuth();
                    }
                } catch(e){}
            }
        }

        // 2. Auth Logic
        function checkAuth() {
            const authDiv = document.getElementById('authSection');
            if (currentUser) {
                authDiv.innerHTML = `
                    <div class="hidden sm:flex items-center bg-slate-100 rounded-xl p-1 border border-slate-200">
                        <span class="px-3 text-sm font-bold text-slate-600">${currentUser.name}</span>
                        <div class="bg-white px-3 py-1 rounded-lg shadow-sm border border-slate-200 text-emerald-600 font-extrabold flex items-center">
                            $${currentUser.balanceUsd.toFixed(2)}
                        </div>
                    </div>
                    <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-sm transition-all text-sm">
                        <i class="fa-solid fa-plus mr-1"></i> Add Fund
                    </button>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition-colors" title="Logout"><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
                `;
            } else {
                authDiv.innerHTML = `
                    <a href="/login" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-2 px-5 rounded-xl transition-all shadow-sm">Login / Register</a>
                `;
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.reload();
        }

        // 3. Products Logic
        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                const list = document.getElementById('product-list');
                list.innerHTML = '';

                if(products.length === 0) { list.innerHTML = '<p class="col-span-full text-center py-10">No products available.</p>'; return; }

                products.forEach(p => {
                    const priceNum = p.price.replace(/[^0-9.]/g, ''); // Extract number from price
                    list.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-xl transition-all flex flex-col justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">${p.name}</h2>
                                <span class="inline-block bg-emerald-100 text-emerald-700 font-bold px-3 py-1 rounded-lg text-sm mb-4">$${priceNum}</span>
                                <p class="text-sm text-slate-600 mb-6 bg-slate-50 p-3 rounded-lg border border-slate-100">${p.abilities}</p>
                            </div>
                            <button onclick="buyProduct('${p.name}', ${priceNum})" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-blue-600 transition-all flex justify-center items-center gap-2">
                                <i class="fa-solid fa-cart-shopping"></i> Buy Source Code
                            </button>
                        </div>
                    `;
                });
            } catch(e) {}
        }

        function buyProduct(name, price) {
            if(!currentUser) {
                Swal.fire('Login Required', 'Please login to buy source codes.', 'info').then(() => window.location.href='/login');
                return;
            }
            if(currentUser.balanceUsd < price) {
                Swal.fire({
                    title: 'Insufficient Balance', 
                    html: `You have <b>$${currentUser.balanceUsd.toFixed(2)}</b> but this costs <b>$${price}</b>.<br>Please add funds.`, 
                    icon: 'warning',
                    confirmButtonText: 'Add Fund',
                    confirmButtonColor: '#3b82f6'
                }).then((res) => { if(res.isConfirmed) openModal(); });
            } else {
                Swal.fire('Success', 'Contact admin on Telegram with your email to receive the code file! Automatic delivery coming soon.', 'success');
            }
        }

        // 4. Add Fund Modal Logic
        function openModal() { document.getElementById('addFundModal').classList.replace('hidden', 'flex'); }
        function closeModal() { document.getElementById('addFundModal').classList.replace('flex', 'hidden'); }

        function calcBdt() {
            const usd = parseFloat(document.getElementById('usdAmount').value) || 0;
            const bdt = Math.round(usd * liveRate);
            document.getElementById('bdtAmount').value = bdt + ' ৳';
            document.getElementById('insAmount').innerText = bdt;
        }

        function updateTheme() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const header = document.getElementById('modalHeader');
            const box = document.getElementById('instructionBox');
            const btn = document.getElementById('submitBtn');
            const textLists = box.querySelectorAll('p, ol, b');

            // Reset classes
            header.className = 'p-4 flex justify-between items-center text-white transition-colors duration-300';
            box.className = 'border p-4 rounded-xl text-sm transition-colors duration-300';
            btn.className = 'w-full font-bold py-3 rounded-xl shadow-md transition-all text-white';

            let number = '01846849460';
            let name = '';

            if(method === 'bkash') {
                header.classList.add('bg-[#e2136e]');
                box.classList.add('bg-pink-50', 'border-pink-200');
                textLists.forEach(el => el.style.color = '#e2136e');
                btn.classList.add('bg-[#e2136e]', 'hover:bg-pink-700');
                name = 'bKash';
            } else if(method === 'nagad') {
                header.classList.add('bg-[#f37021]');
                box.classList.add('bg-orange-50', 'border-orange-200');
                textLists.forEach(el => el.style.color = '#f37021');
                btn.classList.add('bg-[#f37021]', 'hover:bg-orange-600');
                name = 'Nagad';
            } else if(method === 'rocket') {
                number = '018468494606'; // Rocket number
                header.classList.add('bg-[#8c1596]');
                box.classList.add('bg-purple-50', 'border-purple-200');
                textLists.forEach(el => el.style.color = '#8c1596');
                btn.classList.add('bg-[#8c1596]', 'hover:bg-purple-700');
                name = 'Rocket';
            }

            box.querySelector('ol li:nth-child(1)').innerHTML = `Go to your ${name} App.`;
            box.querySelector('ol li:nth-child(3)').innerHTML = `Enter Number: <b class="text-lg" style="color: inherit;">${number}</b>`;
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const method = document.querySelector('input[name="method"]:checked').value;
            const bdtRaw = document.getElementById('bdtAmount').value;
            const amountBdt = parseFloat(bdtRaw.replace(/[^0-9.]/g, ''));
            const senderNumber = document.getElementById('senderNumber').value;
            const trxId = document.getElementById('trxId').value;

            if(amountBdt <= 0) return Swal.fire('Error', 'Amount must be greater than 0', 'error');

            btn = document.getElementById('submitBtn');
            btn.innerText = 'Submitting...';

            const res = await fetch('/api/deposit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, method, amountBdt, senderNumber, trxId })
            });
            const data = await res.json();
            
            if(data.success) {
                closeModal();
                Swal.fire('Success!', 'Deposit request sent to admin. Your balance will be updated upon approval.', 'success');
                document.getElementById('depositForm').reset();
                updateTheme();
            } else {
                Swal.fire('Error', data.error, 'error');
            }
            btn.innerText = 'Submit Request';
        });

        // Run
        init();
        updateTheme(); // Set default bkash theme
    </script>
</body>
</html>
